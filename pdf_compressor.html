<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Compressor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
            border: 5px solid rgba(26, 25, 25, 1); /* Visible border */
        }
        input, button {
            margin: 10px;
            padding: 10px;
        }
        #downloadLink {
            display: none;
            margin-top: 20px;
            padding: 10px;
            background-color: green;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
        .slider-container {
            margin: 10px;
        }
        #loadingText {
            display: none;
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <h2>PDF Compressor</h2>
    <input type="file" id="pdfInput" accept="application/pdf">
    
    <div class="slider-container">
        <label for="sizeSlider">Target File Size:</label>
        <input type="range" id="sizeSlider" min="50" max="2000" step="1" value="500">
        <span id="sizeValue">500 KB</span>
    </div>
    
    <button onclick="compressPDF()">Compress PDF</button>

    <p id="loadingText">Please wait...</p> <!-- Hidden Text -->
    
    <p id="sizeInfo"></p>
    <a id="downloadLink">Download Compressed PDF</a>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.min.js"></script>

    <script>
    document.getElementById("sizeSlider").addEventListener("input", function() {
        document.getElementById("sizeValue").innerText = this.value + " KB";
    });

    document.getElementById("pdfInput").addEventListener("change", function () {
        document.getElementById("sizeInfo").innerText = "";
        document.getElementById("downloadLink").style.display = "none";
    });

    async function compressPDF() {
        const fileInput = document.getElementById("pdfInput");
        const loadingText = document.getElementById("loadingText");

        if (fileInput.files.length === 0) {
            alert("Please select a PDF file first.");
            return;
        }

        loadingText.style.display = "block"; // Show "Please wait..." message

        const file = fileInput.files[0];
        const reader = new FileReader();
        const targetSizeKB = parseFloat(document.getElementById("sizeSlider").value);

        reader.onload = async function(event) {
            const pdfData = new Uint8Array(event.target.result);
            const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;

            const { jsPDF } = window.jspdf;
            let compressionQuality = 0.9;
            let compressedPdf, compressedSizeKB;
            let qualityStep = 0.02;
            let attempt = 0;

            do {
                attempt++;
                let doc = new jsPDF(); 

                for (let i = 0; i < pdf.numPages; i++) {
                    const canvas = document.createElement("canvas");
                    const context = canvas.getContext("2d");

                    const page = await pdf.getPage(i + 1);
                    const viewport = page.getViewport({ scale: 1 });
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;

                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                    
                    const compressedImage = await compressImage(canvas.toDataURL("image/jpeg", compressionQuality));

                    if (i !== 0) doc.addPage();
                    doc.addImage(compressedImage, "JPEG", 0, 0, 210, 297);
                }

                compressedPdf = doc.output("blob");
                compressedSizeKB = compressedPdf.size / 1024;

                console.log(`Attempt ${attempt}: Quality = ${compressionQuality.toFixed(2)}, Size = ${compressedSizeKB.toFixed(2)} KB`);

                if (compressedSizeKB < targetSizeKB - 10) {
                    compressionQuality += qualityStep;
                } else if (compressedSizeKB > targetSizeKB + 10) {
                    compressionQuality -= qualityStep;
                } else {
                    break;
                }

            } while (compressionQuality > 0.05 && compressionQuality < 0.9);

            loadingText.style.display = "none"; // Hide "Please wait..." message

            document.getElementById("sizeInfo").innerText = "Final Compressed Size: " + compressedSizeKB.toFixed(2) + " KB";

            const url = URL.createObjectURL(compressedPdf);
            const downloadLink = document.getElementById("downloadLink");
            downloadLink.href = url;
            downloadLink.download = "compressed.pdf";
            downloadLink.style.display = "block";
            downloadLink.innerText = "Download Compressed PDF";
        };

        reader.readAsArrayBuffer(file);
    }

    async function compressImage(imageDataUrl) {
        const options = {
            maxSizeMB: 0.1,
            maxWidthOrHeight: 1024,
            useWebWorker: true
        };

        try {
            const blob = await (await fetch(imageDataUrl)).blob();
            const compressedBlob = await imageCompression(blob, options);
            return URL.createObjectURL(compressedBlob);
        } catch (error) {
            console.error("Image compression error:", error);
            return imageDataUrl;
        }
    }
    </script>

</body>
</html>